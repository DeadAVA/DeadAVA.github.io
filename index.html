<!DOCTYPE html>
<html>
  <head>
    <title>Rutas de Transporte</title>
    <script>
      let map;
      let userLocation; // Será actualizada mediante la función actualizarUbicacion
      let userMarker; // Marcador para la ubicación del usuario
      let currentRouteData = null;
      const DISTANCE_THRESHOLD = 500; // Umbral de distancia en metros
      const routeColors = ["#FF0000", "#00FF00", "#0000FF", "#FF00FF", "#00FFFF"];

      // Función para obtener parámetros de la URL
      function getParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Función para calcular la distancia entre dos puntos (fórmula de Haversine)
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radio de la Tierra en km
        const dLat = (lat2 - lat1) * (Math.PI / 180);
        const dLon = (lon2 - lon1) * (Math.PI / 180);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
          Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distanceKm = R * c;
        return { km: distanceKm, meters: distanceKm * 1000 };
      }

      // Función que será llamada desde App Inventor para actualizar la ubicación
      // pos debe ser un objeto con la forma: { lat: <valor>, lng: <valor> }
      function actualizarUbicacion(pos) {
        userLocation = pos;
        if (map) {
          // Si el marcador aún no existe, se crea; de lo contrario se actualiza su posición
          if (!userMarker) {
            userMarker = new google.maps.Marker({
              position: userLocation,
              map: map,
              title: "Tu ubicación",
              icon: {
                url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                scaledSize: new google.maps.Size(40, 40)
              }
            });
          } else {
            userMarker.setPosition(userLocation);
          }
          // Centrar el mapa en la ubicación actualizada
          map.setCenter(userLocation);
          updateDistanceForCurrentRoute();
        }
      }

      // Función para recalcular la distancia de la ubicación actual a la ruta actual
      function updateDistanceForCurrentRoute() {
        if (currentRouteData && userLocation) {
          let nearestWaypoint = null;
          let minDistance = Infinity;

          // Calcular el waypoint más cercano
          currentRouteData.waypoints.forEach((waypoint) => {
            const d = calculateDistance(
              userLocation.lat,
              userLocation.lng,
              waypoint.location.lat,
              waypoint.location.lng
            );
            if (d.meters < minDistance) {
              minDistance = d.meters;
              nearestWaypoint = waypoint;
            }
          });

          if (nearestWaypoint) {
            const distanceText = (minDistance <= 1000
              ? Math.round(minDistance) + " metros"
              : (minDistance / 1000).toFixed(2) + " km");
            const proximity = minDistance <= DISTANCE_THRESHOLD ? "Cercana" : "Lejana";

            // Preparar la información a enviar a App Inventor
            const infoParaEnviar = `Ruta: ${currentRouteData.routeId} | Waypoint más cercano: (${nearestWaypoint.location.lat}, ${nearestWaypoint.location.lng}) | Distancia: ${distanceText} | Estado: ${proximity}`;
            if (typeof AppInventor !== "undefined") {
              AppInventor.setWebViewString(infoParaEnviar);
            } else {
              console.log("AppInventor no está definido. Información para enviar:", infoParaEnviar);
            }
          }
        }
      }

      // Función para inicializar el mapa y dibujar rutas
      function initMap() {
        // Si aún no se ha recibido una ubicación, usar una por defecto
        if (!userLocation) {
          userLocation = { lat: 31.8687503, lng: -116.6238947 };
        }
        const mapDiv = document.getElementById("map");
        if (!mapDiv) {
          console.error("No se encontró el div con ID 'map'");
          return;
        }
        map = new google.maps.Map(mapDiv, {
          zoom: 12,
          center: userLocation
        });

        // Definición de las rutas
        const routes = [
          {
            routeId: "1",
            origin: { lat: 31.9031497, lng: -116.732758 },
            destination: { lat: 31.7284971, lng: -116.578593 },
            waypoints: [
              { location: { lat: 31.8654668, lng: -116.6230706 }, stopover: true },
              { location: { lat: 31.8494301, lng: -116.6141052 }, stopover: true }
            ]
          },
          {
            routeId: "2",
            origin: { lat: 31.8687503, lng: -116.6238947 },
            destination: { lat: 31.8254551, lng: -116.5977344 },
            waypoints: [
              { location: { lat: 31.8709514, lng: -116.6076021 }, stopover: true },
              { location: { lat: 31.84775, lng: -116.5901801 }, stopover: true },
              { location: { lat: 31.8267228, lng: -116.5976809 }, stopover: true },
              { location: { lat: 31.8056873, lng: -116.5947246 }, stopover: true },
              { location: { lat: 31.825138, lng: -116.5983726 }, stopover: true }
            ]
          }
        ];

        // Verificar si se proporciona un routeId en la URL
        const paramRouteId = getParameter("routeId");
        if (paramRouteId) {
          const selectedRoute = routes.find(r => r.routeId === paramRouteId);
          if (selectedRoute) {
            currentRouteData = selectedRoute;
            drawRoute(selectedRoute, routeColors[0]); // Dibujar la ruta seleccionada
          } else {
            console.error("No se encontró la ruta con routeId =", paramRouteId);
          }
        } else {
          // Dibujar todas las rutas si no se especifica un routeId
          routes.forEach((route, index) => {
            const color = routeColors[index % routeColors.length];
            drawRoute(route, color);
          });
        }
      }

      // Función para dibujar una ruta en el mapa
      function drawRoute(routeData, color) {
        const directionsService = new google.maps.DirectionsService();
        const directionsRenderer = new google.maps.DirectionsRenderer({
          polylineOptions: { strokeColor: color, strokeWeight: 5 }
        });
        directionsRenderer.setMap(map);

        const request = {
          origin: routeData.origin,
          destination: routeData.destination,
          waypoints: routeData.waypoints,
          travelMode: "DRIVING"
        };

        directionsService.route(request, (result, status) => {
          if (status === "OK") {
            directionsRenderer.setDirections(result);
          } else {
            console.error("Error al trazar la ruta:", status);
          }
        });
      }

      // Iniciar el mapa al cargar la página
      window.onload = () => {
        initMap();
      };
    </script>
  </head>
  <body>
    <div id="map" style="height: 100vh; width: 100%;"></div>
  </body>
  <!-- Reemplaza YOUR_API_KEY con tu clave real de Google Maps -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCqfzq_SSagdWTP0-nLG4jDM7k4brgcM_Y&callback=initMap"></script>
</html>
